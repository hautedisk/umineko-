<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>うみねこ2 Lite v5</title>
  <style>
    :root { --p: #4a90e2; --s: #2ecc71; --d: #e74c3c; --bg: #f0f2f5; }
    body { font-family: sans-serif; padding: 10px; background: var(--bg); margin: 0; font-size: 14px; }
    h2 { font-size: 18px; margin: 10px 0; color: #333; }
    .card { background: white; padding: 12px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 12px; }
    
    .grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 10px; }
    .item { display: flex; flex-direction: column; }
    label { font-size: 10px; color: #666; font-weight: bold; margin-bottom: 2px; text-align: center; }
    input { padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; width: 100%; box-sizing: border-box; text-align: center; }
    
    button { width: 100%; padding: 12px; font-size: 16px; font-weight: bold; border: none; border-radius: 8px; background: var(--p); color: white; }
    .btn-edit-mode { background: var(--s); }

    #total { background: #333; color: white; display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
    .total-main { grid-column: 1 / 3; font-size: 20px; border-bottom: 1px solid #555; padding-bottom: 5px; text-align: center; }

    .log-item { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding: 10px 0; }
    .log-item:last-child { border: 0; }
    .log-left { flex: 1.2; }
    .log-right { text-align: right; flex: 0.8; }
    .date { font-size: 11px; color: #888; }
    .val { font-weight: bold; font-size: 15px; }
    .sub { font-size: 11px; color: #666; }
    .plus { color: var(--s); }
    .minus { color: var(--d); }
    
    .actions { display: flex; gap: 5px; margin-top: 5px; justify-content: flex-end; }
    .btn-s { padding: 4px 10px; font-size: 11px; border-radius: 4px; color: white; cursor: pointer; }
  </style>
</head>
<body>

<div id="total" class="card">
  <div class="total-main" id="totalDiff">---円</div>
  <div id="totalCoins" class="sub">枚数: --</div>
  <div id="totalVita" class="sub" style="text-align:right;">ビタ: --%</div>
</div>

<div class="card">
  <input type="hidden" id="editId">
  <div class="grid">
    <div class="item" style="grid-column: span 3;">
      <label>日付</label>
      <input type="date" id="date">
    </div>
    <div class="item">
      <label>貸(枚/1k)</label>
      <input type="number" id="lend" inputmode="decimal" placeholder="46">
    </div>
    <div class="item">
      <label>払(枚/1k)</label>
      <input type="number" id="pay" inputmode="decimal" placeholder="50">
    </div>
    <div class="item">
      <label>回転数</label>
      <input type="number" id="spins" inputmode="numeric" placeholder="0">
    </div>
    <div class="item">
      <label>入金(枚)</label>
      <input type="number" id="inC" inputmode="numeric" placeholder="0">
    </div>
    <div class="item">
      <label>出金(枚)</label>
      <input type="number" id="outC" inputmode="numeric" placeholder="0">
    </div>
    <div class="item">
      <label>成功 / 発生</label>
      <div style="display:flex; gap:2px;">
        <input type="number" id="vSucc" inputmode="numeric" placeholder="成">
        <input type="number" id="vAtt" inputmode="numeric" placeholder="発">
      </div>
    </div>
  </div>
  <button id="submitBtn" onclick="add()">記録を保存</button>
</div>

<h3>履歴</h3>
<div class="card" id="logList"></div>

<script>
  let data = JSON.parse(localStorage.getItem("umi_v5") || "[]");
  
  document.getElementById("date").value = new Date().toISOString().split("T")[0];
  document.getElementById("lend").value = "46";
  document.getElementById("pay").value = "50";

  function add() {
    const id = document.getElementById("editId").value;
    const lVal = +document.getElementById("lend").value;
    const pVal = +document.getElementById("pay").value;
    
    if (!lVal || !pVal) { alert("貸・払レートを入力してください"); return; }

    const d = {
      id: id ? Number(id) : Date.now(),
      date: document.getElementById("date").value,
      lend: lVal,
      pay: pVal,
      inC: +document.getElementById("inC").value,
      outC: +document.getElementById("outC").value,
      spins: +document.getElementById("spins").value,
      vAtt: +document.getElementById("vAtt").value,
      vSucc: +document.getElementById("vSucc").value,
    };
    
    if (id) {
      const idx = data.findIndex(x => x.id === Number(id));
      data[idx] = d;
    } else {
      data.push(d);
    }
    
    localStorage.setItem("umi_v5", JSON.stringify(data));
    resetForm();
    render();
  }

  function edit(id) {
    const item = data.find(x => x.id === id);
    document.getElementById("editId").value = item.id;
    document.getElementById("date").value = item.date;
    document.getElementById("lend").value = item.lend;
    document.getElementById("pay").value = item.pay;
    document.getElementById("inC").value = item.inC;
    document.getElementById("outC").value = item.outC;
    document.getElementById("spins").value = item.spins;
    document.getElementById("vAtt").value = item.vAtt;
    document.getElementById("vSucc").value = item.vSucc;
    
    document.getElementById("submitBtn").innerText = "修正を反映";
    document.getElementById("submitBtn").classList.add("btn-edit-mode");
    window.scrollTo(0,0);
  }

  function resetForm() {
    document.getElementById("editId").value = "";
    ["inC", "outC", "spins", "vAtt", "vSucc"].forEach(id => document.getElementById(id).value = "");
    document.getElementById("submitBtn").innerText = "記録を保存";
    document.getElementById("submitBtn").classList.remove("btn-edit-mode");
  }

  function remove(id) {
    if(confirm("削除しますか？")) {
      data = data.filter(x => x.id !== id);
      localStorage.setItem("umi_v5", JSON.stringify(data));
      render();
    }
  }

  function render() {
    const list = document.getElementById("logList");
    list.innerHTML = "";
    let tInvY = 0, tColY = 0, tInC = 0, tOutC = 0, tAtt = 0, tSucc = 0;

    data.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(x => {
      // 投資：そのまま計算
      const invY = (x.inC / x.lend) * 1000;
      // 回収：金額換算後に500円単位で切り捨て
      let colY = (x.outC / x.pay) * 1000;
      colY = Math.floor(colY / 500) * 500; 

      const diff = colY - invY;
      const rate = x.vAtt > 0 ? ((x.vSucc / x.vAtt) * 100).toFixed(1) : "0.0";
      
      tInvY += invY; tColY += colY; tInC += x.inC; tOutC += x.outC; tAtt += x.vAtt; tSucc += x.vSucc;

      list.innerHTML += `
        <div class="log-item">
          <div class="log-left">
            <div class="date">${x.date} <span style="margin-left:5px; color:#aaa;">(${x.lend}→${x.pay})</span></div>
            <div class="val ${diff >= 0 ? 'plus' : 'minus'}">${Math.round(diff).toLocaleString()}円</div>
            <div class="sub">枚数: In ${x.inC} / Out ${x.outC}</div>
          </div>
          <div class="log-right">
            <div class="sub">成功率</div>
            <div class="val" style="color:var(--p)">${rate}%</div>
            <div class="actions">
              <span class="btn-s" style="background:var(--s)" onclick="edit(${x.id})">編集</span>
              <span class="btn-s" style="background:var(--d)" onclick="remove(${x.id})">削除</span>
            </div>
          </div>
        </div>
      `;
    });

    const totalDiff = tColY - tInvY;
    document.getElementById("totalDiff").innerText = Math.round(totalDiff).toLocaleString() + "円";
    document.getElementById("totalDiff").className = "total-main " + (totalDiff >= 0 ? "plus" : "minus");
    document.getElementById("totalCoins").innerText = `枚数: 入 ${tInC.toLocaleString()} / 出 ${tOutC.toLocaleString()}`;
    document.getElementById("totalVita").innerText = `ビタ: ${tAtt > 0 ? (tSucc/tAtt*100).toFixed(1) : 0}% (${tSucc}/${tAtt})`;
  }

  render();
</script>
</body>
</html>
