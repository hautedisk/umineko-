<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>うみねこ2 収支・データ管理</title>
  <link rel="apple-touch-icon" href="https://amusement-japan.co.jp/img/upload/20251202_1764661445.jpg">
  <link rel="icon" href="https://amusement-japan.co.jp/img/upload/20251202_1764661445.jpg">
  <style>
    :root { --p: #4a90e2; --s: #2ecc71; --d: #e74c3c; --bg: #f0f2f5; --gold: #d4af37; }
    body { font-family: sans-serif; padding: 8px; background: var(--bg); margin: 0; font-size: 13px; -webkit-tap-highlight-color: transparent; }
    .card { background: white; padding: 8px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 6px; box-sizing: border-box; }
    
    #total { background: #333; color: white; padding: 10px; position: relative;}
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .total-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; text-align: center; }
    .total-box { border: 1px solid #444; padding: 4px; border-radius: 6px; }
    .total-label { font-size: 8px; color: #aaa; margin-bottom: 1px; display: block; }
    .total-val { font-size: 16px; font-weight: bold; }
    
    .benefit-area { 
        border-top: 1px solid #444; 
        margin-top: 8px; 
        padding-top: 8px; 
        text-align: center;
        display: grid; 
        grid-template-columns: 1fr 1fr; 
        gap: 4px;
    }
    .b-item { 
        font-size: 9px; 
        line-height: 1.1; 
        letter-spacing: -0.5px;
    }
    .t-gold, .t-red {
        white-space: nowrap; 
    }
    
    .t-gold { color: var(--gold); font-weight: bold; }
    .t-red { color: #ff6b6b; font-weight: bold; }
    .data-stats { font-size: 9px; color: #eee; margin-top: 6px; border-top: 1px solid #444; padding-top: 4px; display: grid; grid-template-columns: 1fr 1fr; gap: 3px; }

    .tab-menu { display: flex; gap: 6px; margin-bottom: 6px; }
    .tab-btn { flex: 1; padding: 6px; background: #ddd; border: none; border-radius: 6px; font-size: 11px; cursor: pointer; text-align: center; color: #333;}
    .tab-btn.active { background: var(--p); color: white; font-weight: bold; }

    #graphContainer { width: 100%; height: 250px; position: relative; margin-top: 6px; }
    canvas { width: 100%; height: 100%; }

    .grid-row { display: grid; gap: 4px; margin-bottom: 6px; }
    .cols-3 { grid-template-columns: 1fr 1fr 1fr; }
    .cols-2 { grid-template-columns: 1fr 1fr; }
    .item { display: flex; flex-direction: column; justify-content: flex-end; }
    label { font-size: 8px; color: #666; font-weight: bold; margin-bottom: 1px; text-align: center; }
    input { padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; width: 100%; box-sizing: border-box; text-align: center; height: 30px; }
    
    .date-row { text-align: center; margin-bottom: 8px; }
    #date { width: 60%; font-size: 12px; height: 30px; border: 1px solid #ccc; background: #fafafa; }

    .toggle-group { display: flex; background: #eee; border-radius: 4px; padding: 1px; margin-bottom: 2px; height: 18px; }
    .toggle-btn { flex: 1; border: none; background: none; font-size: 8px; cursor: pointer; color: #666; height: 100%; border-radius: 3px; }
    .toggle-btn.active { background: white; color: var(--p); font-weight: bold; }

    button.main-btn { width: 100%; padding: 10px; font-size: 14px; font-weight: bold; border: none; border-radius: 6px; background: var(--p); color: white; cursor: pointer; }
    .btn-edit-mode { background: var(--s) !important; }

    /* ★修正箇所：履歴コンテナをスクロール可能にする */
    #logContainer {
        max-height: 400px;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        padding-right: 4px;
    }
    
    .log-item { padding: 6px; margin-bottom: 6px; }
    .log-row { display: grid; grid-template-columns: 85px 1fr; align-items: center; gap: 6px; }
    
    .log-left { display: flex; flex-direction: column; align-items: flex-start; gap: 1px; }
    .date-box { font-size: 10px; color: #888; font-weight: bold; }
    .val-container { text-align: left; }
    .val-label { font-size: 7px; color: #666; display: block; margin-top: 2px;}
    .val { font-weight: bold; font-size: 13px; display: block; line-height: 1.1; }
    .plus { color: var(--s); }
    .minus { color: var(--d); }
    
    .log-center { display: flex; flex-direction: column; gap: 2px; min-width: 0; padding: 0; }
    
    .bonuses { display: flex; justify-content: space-between; background: #f9f9f9; padding: 2px 4px; border-radius: 4px; border: 1px solid #eee; }
    .b-item { text-align: center; flex: 1; }
    .b-label { color: #555; font-size: 8px; display: block; font-weight: bold; }
    .b-val { font-weight: bold; color: #000; font-size: 12px; display: block; }
    
    .shop-box { font-size: 8px; color: #666; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding: 0 4px; }
    
    .actions { display: flex; gap: 4px; margin-top: 4px; }
    .btn-s { flex: 1; padding: 4px 2px; font-size: 10px; font-weight: bold; border-radius: 4px; color: white; border: none; cursor: pointer; }

    #customDialog { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; align-items: center; justify-content: center; }
    .dialog-card { background: white; width: 80%; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.3); }
    #dialogMsg { font-size: 18px; font-weight: bold; color: #333; margin-bottom: 20px; line-height: 1.3; }
    .dialog-btns { display: flex; gap: 10px; }
    .dialog-btns button { flex: 1; padding: 10px; border-radius: 6px; border: none; font-size: 14px; font-weight: bold; }
    .btn-cancel { background: #eee; color: #666; }
    .btn-delete { background: var(--d); color: white; }
  </style>
</head>
<body>

<div class="tab-menu">
  <button class="tab-btn active" onclick="switchTab('data')">累計データ</button>
  <button class="tab-btn" onclick="switchTab('graph')">スランプグラフ</button>
</div>

<div id="total" class="card">
  <div id="tab-data" class="tab-content active">
    <div class="total-grid">
      <div class="total-box"><span class="total-label">累計収支</span><span id="totalYen" class="total-val">---円</span></div>
      <div class="total-box"><span class="total-label">総差枚数</span><span id="totalCoins" class="total-val">---枚</span></div>
    </div>
    <div class="benefit-area">
      <div class="b-item"><div class="t-gold">貯メダルによる得 </div><div id="saveYen">0円</div><div id="saveCoin" style="color:#aaa">0枚</div></div>
      <div class="b-item"><div class="t-red">換金による損 </div><div id="lostYen">0円</div><div id="lostCoin" style="color:#aaa">0枚</div></div>
    </div>
    <div class="data-stats">
        <div>ビタ: <span id="totalVita" style="color:#fff">--%</span></div>
        <div>回転: <span id="totalSpins" style="color:#fff">--</span></div>
        <div>BB: <span id="totalBB" style="color:#fff">--</span></div>
        <div>RB: <span id="totalRB" style="color:#fff">--</span></div>
        <div>BB確: <span id="totalBBProb" style="color:#fff">--</span></div>
        <div>RB確: <span id="totalRBProb" style="color:#fff">--</span></div>
    </div>
  </div>

  <div id="tab-graph" class="tab-content">
    <div id="graphContainer">
      <canvas id="slopeGraph"></canvas>
    </div>
  </div>
</div>

<div class="card">
  <input type="hidden" id="editId">
  <div class="date-row"><label>日付</label><br><input type="date" id="date"></div>
  <div class="grid-row cols-3">
    <div class="item"><label>貸</label><input type="number" id="lend" value="46"></div>
    <div class="item"><label>払</label><input type="number" id="pay" value="50"></div>
    <div class="item"><label>回転数</label><input type="number" id="spins" placeholder="0"></div>
  </div>
  <div class="grid-row cols-3">
    <div class="item">
      <div class="toggle-group"><button id="mInC" class="toggle-btn active" onclick="setIn('C')">枚数</button><button id="mInY" class="toggle-btn" onclick="setIn('Y')">金額</button></div>
      <input type="number" id="inV" placeholder="投資">
    </div>
    <div class="item">
      <div class="toggle-group"><button id="mOutCash" class="toggle-btn active" onclick="setOut('CASH')">換金</button><button id="mOutSave" class="toggle-btn" onclick="setOut('SAVE')">貯メ</button></div>
      <input type="number" id="outV" placeholder="回収枚数">
    </div>
    <div class="item"><label>ビタ成功/発生</label><div style="display:flex; gap:2px;"><input type="number" id="vS" placeholder="成"><input type="number" id="vA" placeholder="発"></div></div>
  </div>
  <div class="grid-row cols-2">
    <div class="item"><label>BB回数</label><input type="number" id="bb" placeholder="0"></div>
    <div class="item"><label>RB回数</label><input type="number" id="rb" placeholder="0"></div>
  </div>
  <div style="margin-bottom: 8px;">
    <label>店名</label>
    <input type="text" id="shopName" placeholder="店舗名">
  </div>
  <button id="submitBtn" class="main-btn" onclick="add()">記録を保存</button>
</div>

<h3>履歴</h3>
<div id="logContainer">
    <div id="logList"></div>
</div>

<div id="customDialog">
  <div class="dialog-card">
    <div id="dialogMsg"></div>
    <div class="dialog-btns">
      <button class="btn-cancel" onclick="closeDialog()">やめる</button>
      <button id="confirmDeleteBtn" class="btn-delete">削除する</button>
    </div>
  </div>
</div>

<script>
  // データの引き継ぎ設定
  const OLD_KEY = "umi_v15";
  const NEW_KEY = "umi_v32";
  
  // 以前のデータがあれば読み込む
  let data = JSON.parse(localStorage.getItem(NEW_KEY));
  if (data === null) {
      data = JSON.parse(localStorage.getItem(OLD_KEY) || "[]");
      localStorage.setItem(NEW_KEY, JSON.stringify(data));
  }
  
  let inM = 'C', outM = 'CASH';
  document.getElementById("date").value = new Date().toISOString().split("T")[0];

  function setIn(m) { inM = m; document.getElementById("mInC").classList.toggle("active", m==='C'); document.getElementById("mInY").classList.toggle("active", m==='Y'); }
  function setOut(m) { outM = m; document.getElementById("mOutCash").classList.toggle("active", m==='CASH'); document.getElementById("mOutSave").classList.toggle("active", m==='SAVE'); }

  function switchTab(tab) {
    document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
    document.getElementById('tab-' + tab).classList.add('active');
    event.currentTarget.classList.add('active');
    if(tab === 'graph') drawGraph();
  }

  function add() {
    const id = document.getElementById("editId").value;
    const l = parseFloat(document.getElementById("lend").value);
    const p = parseFloat(document.getElementById("pay").value);
    const inVal = parseFloat(document.getElementById("inV").value) || 0;
    const outC = parseFloat(document.getElementById("outV").value) || 0;
    
    let inC = inM === 'C' ? inVal : (inVal / 1000) * l;
    let inY = inM === 'Y' ? inVal : (inVal / l) * 1000;
    
    let extraCoins = outC % p; 
    let outY_raw = (outC / p) * 1000;
    let outY_final = 0, saveBC = 0, saveBY = 0, lostBC = 0, lostBY = 0;
    
    if (outM === 'SAVE') { 
      outY_final = outY_raw; 
      saveBC = extraCoins; 
      saveBY = (extraCoins / p) * 1000; 
    } else { 
      outY_final = Math.floor(outY_raw / 500) * 500; 
      lostBC = extraCoins; 
      lostBY = outY_raw - outY_final; 
    }
    
    const rec = { 
      id: id ? Number(id) : Date.now(), 
      date: document.getElementById("date").value, 
      lend: l, pay: p, inC, inY, outC, 
      outY: outY_final, saveBC, saveBY, lostBC, lostBY, outM, inM, 
      spins: Number(document.getElementById("spins").value) || 0, 
      vA: Number(document.getElementById("vA").value) || 0, 
      vS: Number(document.getElementById("vS").value) || 0,
      shopName: document.getElementById("shopName").value,
      bb: Number(document.getElementById("bb").value) || 0,
      rb: Number(document.getElementById("rb").value) || 0
    };
    
    if (id) { data[data.findIndex(x => x.id === Number(id))] = rec; } else { data.push(rec); }
    localStorage.setItem(NEW_KEY, JSON.stringify(data));
    location.reload();
  }

  function edit(id) {
    const x = data.find(x => x.id === id);
    document.getElementById("editId").value = x.id;
    document.getElementById("date").value = x.date;
    document.getElementById("lend").value = x.lend; document.getElementById("pay").value = x.pay;
    document.getElementById("outV").value = x.outC; document.getElementById("spins").value = x.spins;
    document.getElementById("vA").value = x.vA; document.getElementById("vS").value = x.vS;
    document.getElementById("shopName").value = x.shopName || "";
    document.getElementById("bb").value = x.bb || 0;
    document.getElementById("rb").value = x.rb || 0;
    setIn(x.inM || 'C'); setOut(x.outM || 'CASH');
    document.getElementById("inV").value = x.inM === 'Y' ? x.inY : x.inC;
    document.getElementById("submitBtn").innerText = "修正反映";
    document.getElementById("submitBtn").classList.add("btn-edit-mode");
    window.scrollTo(0,0);
  }

  let deleteId = null;
  function remove(id) {
    deleteId = id;
    const msgList = [
      ["ならお前が死ねぇ！", 6], ["…嘘だッ！！！", 2], ["嫌な事件だったね…", 50],
      ["なわけねぇだろぉ", 5], ["制圧しろぉ！", 15], ["再悪回避", 14],
      ["うーうーうー", 4], ["あぅあぅ、消しちゃうのですか？", 3],
      ["【激アツ】消去確定なのですよ。にぱ〜〜☆☆", 1]
    ];
    const totalWeight = msgList.reduce((sum, item) => sum + item[1], 0);
    let randomNum = Math.random() * totalWeight;
    let selectedMsg = "";
    for (const [msg, weight] of msgList) { if (randomNum < weight) { selectedMsg = msg; break; } randomNum -= weight; }
    
    document.getElementById("dialogMsg").innerText = selectedMsg;
    document.getElementById("customDialog").style.display = "flex";
    document.getElementById("confirmDeleteBtn").onclick = () => {
      data = data.filter(x => x.id !== deleteId);
      localStorage.setItem(NEW_KEY, JSON.stringify(data));
      location.reload();
    };
  }
  function closeDialog() { document.getElementById("customDialog").style.display = "none"; }

  // グラフ描画ロジック（グネグネ修正版）
  function drawGraph() {
    const canvas = document.getElementById('slopeGraph');
    const ctx = canvas.getContext('2d');
    const container = document.getElementById('graphContainer');
    
    const dpr = window.devicePixelRatio || 1;
    canvas.width = container.offsetWidth * dpr;
    canvas.height = container.offsetHeight * dpr;
    ctx.scale(dpr, dpr);
    
    const width = container.offsetWidth;
    const height = container.offsetHeight;

    ctx.clearRect(0, 0, width, height);
    if (data.length === 0) return;

    // 日付順に並べ替え
    const sortedData = [...data].sort((a,b) => new Date(a.date) - new Date(b.date));
    
    let cumulativeCoins = 0;
    let currentSpin = 0;
    
    // グラフのデータポイント
    let points = [{x: 0, y: 0}];
    let recordPoints = [{x: 0, y: 0}]; // 実際の記録ポイント

    sortedData.forEach(x => {
      let dailyDiff = x.outC - x.inC;
      cumulativeCoins += dailyDiff;
      currentSpin += x.spins;
      
      // 記録ポイントは直線用
      recordPoints.push({x: currentSpin, y: cumulativeCoins});
      
      // グネグネ用ポイント（日ごとに乱数を発生）
      let steps = Math.max(2, Math.floor(x.spins / 200));
      let lastPoint = points[points.length - 1];
      
      // シード値を日付から生成（再描画しても同じグネグネになる）
      let seed = x.date.split('-').join('') * 1;
      const pseudoRandom = () => {
        seed = (seed * 16807) % 2147483647;
        return (seed - 1) / 2147483646;
      };

      for(let i = 1; i <= steps; i++){
        let progress = i / steps;
        let noise = (pseudoRandom() - 0.5) * (Math.abs(dailyDiff) * 0.3);
        // 端点は記録と一致させる
        if(i === steps) noise = 0;
        
        points.push({
            x: lastPoint.x + (x.spins * progress),
            y: lastPoint.y + (dailyDiff * progress) + noise
        });
      }
    });

    // グラフの範囲計算（実際の記録ベース）
    let yValues = recordPoints.map(p => p.y);
    let minDiff = Math.min(...yValues, 0);
    let maxDiff = Math.max(...yValues, 0);
    
    minDiff = Math.floor(minDiff / 100) * 100;
    maxDiff = Math.ceil(maxDiff / 100) * 100;
    
    let padding = (maxDiff - minDiff) * 0.1 || 100;
    minDiff -= padding;
    maxDiff += padding;
    let yRange = maxDiff - minDiff;

    const margin = {top: 25, right: 40, bottom: 30, left: 50};
    const chartWidth = width - margin.left - margin.right;
    const chartHeight = height - margin.top - margin.bottom;

    const getX = (x) => margin.left + (currentSpin === 0 ? 0 : (x / currentSpin) * chartWidth);
    const getY = (y) => margin.top + chartHeight - ((y - minDiff) / yRange) * chartHeight;

    // 背景・グリッド
    ctx.strokeStyle = '#eee';
    ctx.lineWidth = 1;
    
    let yTicks = 5;
    let tickInterval = Math.ceil((yRange / yTicks) / 100) * 100;
    let startTick = Math.ceil(minDiff / tickInterval) * tickInterval;

    for(let yVal = startTick; yVal <= maxDiff; yVal += tickInterval) {
        let yPos = getY(yVal);
        if (yPos < margin.top || yPos > height - margin.bottom) continue;
        ctx.beginPath();
        ctx.moveTo(margin.left, yPos);
        ctx.lineTo(width - margin.right, yPos);
        ctx.stroke();
        ctx.fillStyle = '#888';
        ctx.font = '10px sans-serif';
        ctx.textAlign = 'right';
        ctx.fillText(Math.round(yVal), margin.left - 5, yPos + 3);
    }
    
    ctx.textAlign = 'center';
    ctx.fillStyle = '#333';
    ctx.fillText("0", getX(0), height - 10);
    ctx.fillText(currentSpin.toLocaleString(), getX(currentSpin), height - 10);

    // ゼロライン
    ctx.beginPath();
    ctx.strokeStyle = '#999';
    ctx.lineWidth = 2;
    ctx.moveTo(margin.left, getY(0));
    ctx.lineTo(width - margin.right, getY(0));
    ctx.stroke();

    // 実際の記録に基づいた最大・最小ライン
    const drawLimitLine = (val, color, label, isTop) => {
        const yPos = getY(val);
        ctx.beginPath();
        ctx.strokeStyle = color;
        ctx.lineWidth = 1;
        ctx.setLineDash([4, 4]);
        ctx.moveTo(margin.left, yPos);
        ctx.lineTo(width - margin.right, yPos);
        ctx.stroke();
        ctx.setLineDash([]);
        ctx.fillStyle = color;
        ctx.font = 'bold 10px sans-serif';
        ctx.textAlign = 'left';
        ctx.fillText(`${label}: ${Math.round(val)}`, margin.left + 5, yPos + (isTop ? -5 : 12));
    };
    
    const actualMax = Math.max(...yValues);
    const actualMin = Math.min(...yValues);
    if (actualMax > 0) drawLimitLine(actualMax, '#d4af37', '最高', true);
    if (actualMin < 0) drawLimitLine(actualMin, '#e74c3c', '最低', false);

    // グラフ本体（グネグネ）
    ctx.beginPath();
    ctx.strokeStyle = '#4a90e2';
    ctx.lineWidth = 2;
    ctx.lineJoin = 'round';
    ctx.lineCap = 'round';
    
    points.forEach((p, i) => {
      if (i === 0) ctx.moveTo(getX(p.x), getY(p.y));
      else ctx.lineTo(getX(p.x), getY(p.y));
    });
    ctx.stroke();
  }

  function render() {
    const list = document.getElementById("logList");
    list.innerHTML = "";
    let tY_raw = 0, tC = 0, tSp = 0, tA = 0, tS = 0, tSaveY = 0, tLostY = 0, tSaveC = 0, tLostC = 0;
    let tBB = 0, tRB = 0;

    const sortedLog = [...data].sort((a,b) => new Date(b.date) - new Date(a.date));
    sortedLog.forEach(x => {
      const dY_500 = Math.floor((x.outY - x.inY) / 500) * 500;
      const dC = x.outC - x.inC;
      tY_raw += (x.outY - x.inY); tC += dC; tSp += x.spins; tA += x.vA; tS += x.vS;
      tSaveY += (x.saveBY || 0); tLostY += (x.lostBY || 0); tSaveC += (x.saveBC || 0); tLostC += (x.lostBC || 0);
      tBB += (x.bb || 0); tRB += (x.rb || 0);
      
      const totalB = (x.bb||0)+(x.rb||0);

      list.innerHTML += `<div class="card log-item">
          <div class="log-row">
            <div class="log-left">
                <div class="date-box">${x.date}</div>
                <div class="val-container">
                    <span class="val-label">収支</span>
                    <span class="val ${dY_500 >= 0 ? 'plus' : 'minus'}">${dY_500.toLocaleString()}円</span>
                    <span class="val-label">差枚</span>
                    <span class="val" style="color:#333;font-size:11px;font-weight:normal;">${dC >= 0 ? '+' : ''}${Math.round(dC).toLocaleString()}枚</span>
                </div>
            </div>
            
            <div class="log-center">
                <div class="bonuses">
                    <div class="b-item"><span class="b-label">BB</span><span class="b-val">${x.bb||0}</span></div>
                    <div class="b-item"><span class="b-label">RB</span><span class="b-val">${x.rb||0}</span></div>
                    <div class="b-item"><span class="b-label">合算</span><span class="b-val">${totalB}</span></div>
                </div>
                <div class="shop-box">${x.shopName || '-'}</div>
                <div class="actions">
                    <button class="btn-s" style="background:var(--s)" onclick="edit(${x.id})">編集</button>
                    <button class="btn-s" style="background:var(--d)" onclick="remove(${x.id})">削除</button>
                </div>
            </div>
          </div>
        </div>`;
    });
    
    // 累計データ計算
    const tY_final = Math.floor(tY_raw / 500) * 500;
    document.getElementById("totalYen").innerText = tY_final.toLocaleString() + "円";
    document.getElementById("totalYen").className = "total-val " + (tY_final >= 0 ? "plus" : "minus");
    document.getElementById("totalCoins").innerText = (tC >= 0 ? "+" : "") + Math.round(tC).toLocaleString() + "枚";
    document.getElementById("saveYen").innerText = Math.round(tSaveY).toLocaleString() + "円";
    document.getElementById("saveCoin").innerText = tSaveC + "枚";
    document.getElementById("lostYen").innerText = Math.round(tLostY).toLocaleString() + "円";
    document.getElementById("lostCoin").innerText = tLostC + "枚";
    
    document.getElementById("totalSpins").innerText = tSp.toLocaleString();
    document.getElementById("totalVita").innerText = (tA > 0 ? (tS/tA*100).toFixed(1) : 0) + "%";
    document.getElementById("totalBB").innerText = tBB;
    document.getElementById("totalRB").innerText = tRB;
    const bbProb = tBB > 0 ? (tSp / tBB).toFixed(1) : "0.0";
    const rbProb = tRB > 0 ? (tSp / tRB).toFixed(1) : "0.0";
    document.getElementById("totalBBProb").innerText = "1/" + bbProb;
    document.getElementById("totalRBProb").innerText = "1/" + rbProb;
    
    // グラフ描画（再計算）
    drawGraph();
  }
  render();
</script>
</body>
</html>
