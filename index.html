<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>収支記録</title>

<style>
  body {
    font-family: sans-serif;
    padding: 10px;
  }
  h2, h3 {
    margin-top: 16px;
  }
  input, select, button {
    width: 100%;
    padding: 8px;
    margin-bottom: 8px;
    font-size: 16px;
  }
  button {
    font-weight: bold;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
  }
  th, td {
    border: 1px solid #ccc;
    padding: 4px;
    font-size: 12px;
    text-align: center;
  }
</style>
</head>

<body>

<h2>うみねこのなく頃に 2 実践記録</h2>

<label>日付</label>
<input type="date" id="date">

<label>貸し枚数</label>
<select id="lend">
  <option value="50">50</option>
  <option value="49">49</option>
  <option value="48">48</option>
  <option value="47">47</option>
  <option value="46">46</option>
</select>

<label>払出し枚数</label>
<select id="pay">
  <option value="52">52</option>
  <option value="51.5">51.5</option>
  <option value="51">51</option>
  <option value="50">50</option>
  <option value="49">49</option>
  <option value="48">48</option>
  <option value="47">47</option>
</select>

<label>入金枚数（投入）</label>
<input type="number" id="inCoins" min="0">

<label>出金枚数（払出）</label>
<input type="number" id="outCoins" min="0">

<label>回転数</label>
<input type="number" id="spins" min="0">

<button id="mainBtn" onclick="add()">記録する</button>

<h3>日別履歴</h3>
<table>
<thead>
<tr>
  <th>日付</th>
  <th>投資</th>
  <th>回収</th>
  <th>収支</th>
  <th>回転</th>
  <th>機械割</th>
  <th>操作</th>
</tr>
</thead>
<tbody id="log"></tbody>
</table>

<h3>合計</h3>
<div id="total"></div>

<script>
/* ---------- 初期設定 ---------- */

document.getElementById("date").value =
  new Date().toISOString().split("T")[0];

let data = JSON.parse(localStorage.getItem("data") || "[]");
let editIndex = null;

/* ---------- 共通 ---------- */

function yen(n){
  return n.toLocaleString() + "円";
}

/* ---------- 記録 / 更新 ---------- */

function add(){
  const date  = document.getElementById("date").value;
  const lend  = +document.getElementById("lend").value;
  const pay   = +document.getElementById("pay").value;
  const inC   = +document.getElementById("inCoins").value;
  const outC  = +document.getElementById("outCoins").value;
  const spins = +document.getElementById("spins").value;

  const investYen = inC / lend * 1000;

  let collectYen = outC / pay * 1000;
  collectYen = Math.floor(collectYen / 500) * 500;

  const diffYen = collectYen - investYen;
  const rate = inC ? ((outC / inC) * 100).toFixed(1) : 0;

  const record = {
    date,
    inC,
    outC,
    investYen,
    collectYen,
    diffYen,
    spins,
    rate
  };

  if(editIndex === null){
    data.push(record);
  }else{
    data[editIndex] = record;
    editIndex = null;
    document.getElementById("mainBtn").textContent = "記録する";
  }

  localStorage.setItem("data", JSON.stringify(data));
  clearInput();
  render();
}

/* ---------- 編集 ---------- */

function edit(i){
  const d = data[i];
  editIndex = i;

  document.getElementById("date").value = d.date;
  document.getElementById("inCoins").value = d.inC;
  document.getElementById("outCoins").value = d.outC;
  document.getElementById("spins").value = d.spins;

  document.getElementById("mainBtn").textContent = "更新する";
}

/* ---------- 削除 ---------- */

function removeData(i){
  if(confirm("この記録を削除しますか？")){
    data.splice(i, 1);
    localStorage.setItem("data", JSON.stringify(data));
    render();
  }
}

/* ---------- 入力クリア ---------- */

function clearInput(){
  document.getElementById("inCoins").value = "";
  document.getElementById("outCoins").value = "";
  document.getElementById("spins").value = "";
}

/* ---------- 表示 ---------- */

function render(){
  const log = document.getElementById("log");
  log.innerHTML = "";

  let totalInC = 0;
  let totalOutC = 0;
  let totalInvest = 0;
  let totalCollect = 0;
  let totalSpins = 0;

  data.forEach((d, i) => {
    totalInC += d.inC;
    totalOutC += d.outC;
    totalInvest += d.investYen;
    totalCollect += d.collectYen;
    totalSpins += d.spins;

    log.innerHTML += `
      <tr>
        <td>${d.date}</td>
        <td>${d.inC}枚<br>${yen(d.investYen)}</td>
        <td>${d.outC}枚<br>${yen(d.collectYen)}</td>
        <td>${d.outC - d.inC}枚<br>${yen(d.diffYen)}</td>
        <td>${d.spins}</td>
        <td>${d.rate}%</td>
        <td>
          <button onclick="edit(${i})">編集</button>
          <button onclick="removeData(${i})">削除</button>
        </td>
      </tr>
    `;
  });

  const avgRate = totalInvest
    ? (totalCollect / totalInvest * 100).toFixed(1)
    : 0;

  document.getElementById("total").innerHTML = `
    総投資：${totalInC}枚（${yen(totalInvest)}）<br>
    総回収：${totalOutC}枚（${yen(totalCollect)}）<br>
    総収支：${totalOutC - totalInC}枚（${yen(totalCollect - totalInvest)}）<br>
    総回転数：${totalSpins}<br>
    平均機械割：${avgRate}%
  `;
}

render();
</script>

</body>
</html>
