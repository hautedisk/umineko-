<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>うみねこ2 収支・貯メダル管理</title>
  <style>
    :root { --p: #4a90e2; --s: #2ecc71; --d: #e74c3c; --bg: #f0f2f5; --gold: #d4af37; }
    body { font-family: sans-serif; padding: 10px; background: var(--bg); margin: 0; font-size: 14px; }
    .card { background: white; padding: 12px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 12px; }
    
    .grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 10px; }
    .item { display: flex; flex-direction: column; justify-content: flex-end; }
    label { font-size: 10px; color: #666; font-weight: bold; margin-bottom: 4px; text-align: center; }
    input { padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; width: 100%; box-sizing: border-box; text-align: center; height: 38px; }
    
    /* 切替ボタン共通 */
    .toggle-group { display: flex; background: #eee; border-radius: 6px; padding: 2px; margin-bottom: 4px; height: 22px; align-items: center; }
    .toggle-btn { flex: 1; border: none; background: none; font-size: 9px; padding: 2px; border-radius: 4px; cursor: pointer; color: #666; height: 100%; }
    .toggle-btn.active { background: white; color: var(--p); font-weight: bold; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
    .toggle-btn.active.save { color: var(--gold); }

    button.main-btn { width: 100%; padding: 12px; font-size: 16px; font-weight: bold; border: none; border-radius: 8px; background: var(--p); color: white; cursor: pointer; }
    .btn-edit-mode { background: var(--s) !important; }

    /* 合計表示 */
    #total { background: #333; color: white; text-align: center; padding: 12px; }
    .total-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .total-box { display: flex; flex-direction: column; border: 1px solid #444; padding: 5px; border-radius: 8px; }
    .total-label { font-size: 9px; color: #aaa; }
    .total-val { font-size: 18px; font-weight: bold; }
    .total-bonus { font-size: 11px; color: var(--gold); margin-top: 4px; font-weight: bold; }
    .total-sub { font-size: 11px; color: #888; border-top: 1px solid #444; margin-top: 8px; padding-top: 8px; grid-column: span 2; }

    /* 履歴 */
    .log-item { border-bottom: 1px solid #eee; padding: 10px 0; display: flex; justify-content: space-between; align-items: center; }
    .log-left { flex: 1; }
    .log-right { text-align: right; }
    .date { font-size: 10px; color: #999; }
    .val { font-weight: bold; font-size: 14px; }
    .sub { font-size: 11px; color: #666; }
    .plus { color: var(--s); }
    .minus { color: var(--d); }
    .tag { font-size: 9px; padding: 1px 4px; border-radius: 3px; margin-left: 4px; color: white; }
    .tag-save { background: var(--gold); }
    .tag-cash { background: #999; }
    
    .actions { display: flex; gap: 4px; margin-top: 4px; justify-content: flex-end; }
    .btn-s { padding: 3px 6px; font-size: 9px; border-radius: 4px; color: white; border: none; }
  </style>
</head>
<body>

<div id="total" class="card">
  <div class="total-grid">
    <div class="total-box">
      <span class="total-label">累計収支</span>
      <span id="totalYen" class="total-val">---円</span>
    </div>
    <div class="total-box">
      <span class="total-label">総差枚数</span>
      <span id="totalCoins" class="total-val">---枚</span>
    </div>
    <div id="bonusArea" class="total-sub" style="border:none; padding:0; color:var(--gold); display:none;">
      貯メダルによる端数・ギャップ得: <span id="totalSavedYen">0</span>円分
    </div>
    <div class="total-sub">
      ビタ: <span id="totalVita" style="color:white">--%</span> / 累計回転: <span id="totalSpins" style="color:white">--</span>
    </div>
  </div>
</div>

<div class="card">
  <input type="hidden" id="editId">
  <div class="grid">
    <div class="item">
      <label>日付</label>
      <input type="date" id="date">
    </div>
    <div class="item">
      <label>貸(枚/1k)</label>
      <input type="number" id="lend" value="46">
    </div>
    <div class="item">
      <label>払(枚/1k)</label>
      <input type="number" id="pay" value="50">
    </div>

    <div class="item">
      <div class="toggle-group">
        <button id="modeInC" class="toggle-btn active" onclick="setInMode('C')">枚数</button>
        <button id="modeInY" class="toggle-btn" onclick="setInMode('Y')">金額</button>
      </div>
      <input type="number" id="inValue" placeholder="投資">
    </div>

    <div class="item">
      <div class="toggle-group">
        <button id="modeOutCash" class="toggle-btn active" onclick="setOutMode('CASH')">換金</button>
        <button id="modeOutSave" class="toggle-btn" onclick="setOutMode('SAVE')">貯メダル</button>
      </div>
      <input type="number" id="outC" placeholder="出金枚数">
    </div>

    <div class="item">
      <label>回転数</label>
      <input type="number" id="spins" placeholder="0">
    </div>

    <div class="item" style="grid-column: span 3;">
      <label>ビタ成功 / 発生</label>
      <div style="display:flex; gap:5px;">
        <input type="number" id="vSucc" placeholder="成功" style="flex:1;">
        <input type="number" id="vAtt" placeholder="発生" style="flex:1;">
      </div>
    </div>
  </div>
  <button id="submitBtn" class="main-btn" onclick="add()">記録を保存</button>
</div>

<h3>履歴</h3>
<div class="card" id="logList"></div>

<script>
  let data = JSON.parse(localStorage.getItem("umi_v8") || "[]");
  let inMode = 'C'; 
  let outMode = 'CASH';

  document.getElementById("date").value = new Date().toISOString().split("T")[0];

  function setInMode(m) {
    inMode = m;
    document.getElementById("modeInC").classList.toggle("active", m === 'C');
    document.getElementById("modeInY").classList.toggle("active", m === 'Y');
  }

  function setOutMode(m) {
    outMode = m;
    document.getElementById("modeOutCash").classList.toggle("active", m === 'CASH');
    document.getElementById("modeOutSave").classList.toggle("active", m === 'SAVE');
  }

  function add() {
    const id = document.getElementById("editId").value;
    const lVal = parseFloat(document.getElementById("lend").value);
    const pVal = parseFloat(document.getElementById("pay").value);
    const inVal = parseFloat(document.getElementById("inValue").value) || 0;
    const outCoins = parseFloat(document.getElementById("outC").value) || 0;

    let inCoins = inMode === 'C' ? inVal : (inVal / 1000) * lVal;
    let investYen = inMode === 'Y' ? inVal : (inVal / lVal) * 1000;

    // 回収計算
    let rawCollectYen = (outCoins / pVal) * 1000;
    let collectYen = 0;
    let savedBenefit = 0;

    if (outMode === 'SAVE') {
      // 貯メダルの場合は「資産」として満額評価（または再プレイ価値）
      // ここでは、本来換金してたら削られていたはずの端数分を「得」としてカウント
      collectYen = rawCollectYen; 
      let cashOutYen = Math.floor(rawCollectYen / 500) * 500;
      savedBenefit = rawCollectYen - cashOutYen; // 端数得
    } else {
      // 換金の場合は500円切り捨て
      collectYen = Math.floor(rawCollectYen / 500) * 500;
      savedBenefit = 0;
    }

    const record = {
      id: id ? Number(id) : Date.now(),
      date: document.getElementById("date").value,
      lend: lVal, pay: pVal,
      inC: inCoins, investYen: investYen,
      outC: outCoins, collectYen: collectYen,
      savedBenefit: savedBenefit,
      outMode: outMode,
      inMode: inMode,
      spins: Number(document.getElementById("spins").value) || 0,
      vAtt: Number(document.getElementById("vAtt").value) || 0,
      vSucc: Number(document.getElementById("vSucc").value) || 0
    };

    if (id) {
      const idx = data.findIndex(x => x.id === Number(id));
      data[idx] = record;
    } else {
      data.push(record);
    }

    localStorage.setItem("umi_v8", JSON.stringify(data));
    resetForm();
    render();
  }

  function edit(id) {
    const x = data.find(x => x.id === id);
    document.getElementById("editId").value = x.id;
    document.getElementById("date").value = x.date;
    document.getElementById("lend").value = x.lend;
    document.getElementById("pay").value = x.pay;
    document.getElementById("outC").value = x.outC;
    document.getElementById("spins").value = x.spins;
    document.getElementById("vAtt").value = x.vAtt;
    document.getElementById("vSucc").value = x.vSucc;
    setInMode(x.inMode || 'C');
    setOutMode(x.outMode || 'CASH');
    document.getElementById("inValue").value = x.inMode === 'Y' ? x.investYen : x.inC;
    document.getElementById("submitBtn").innerText = "修正を反映";
    document.getElementById("submitBtn").classList.add("btn-edit-mode");
    window.scrollTo(0,0);
  }

  function resetForm() {
    document.getElementById("editId").value = "";
    ["inValue", "outC", "spins", "vAtt", "vSucc"].forEach(i => document.getElementById(i).value = "");
    document.getElementById("submitBtn").innerText = "記録を保存";
    document.getElementById("submitBtn").classList.remove("btn-edit-mode");
  }

  function remove(id) {
    if(confirm("削除しますか？")) {
      data = data.filter(x => x.id !== id);
      localStorage.setItem("umi_v8", JSON.stringify(data));
      render();
    }
  }

  function render() {
    const list = document.getElementById("logList");
    list.innerHTML = "";
    let tYen = 0, tCoins = 0, tSpins = 0, tAtt = 0, tSucc = 0, tSaved = 0;

    data.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(x => {
      const diffY = x.collectYen - x.investYen;
      const diffC = x.outC - x.inC;
      tYen += diffY; tCoins += diffC; tSpins += x.spins; tAtt += x.vAtt; tSucc += x.vSucc;
      tSaved += (x.savedBenefit || 0);

      const vRate = x.vAtt > 0 ? ((x.vSucc / x.vAtt) * 100).toFixed(1) : "0.0";
      const modeTag = x.outMode === 'SAVE' ? '<span class="tag tag-save">貯メ</span>' : '<span class="tag tag-cash">換金</span>';

      list.innerHTML += `
        <div class="log-item">
          <div class="log-left">
            <div class="date">${x.date}${modeTag}</div>
            <div class="val ${diffY >= 0 ? 'plus' : 'minus'}">${Math.round(diffY).toLocaleString()}円</div>
            <div class="sub">差枚: ${Math.round(diffC).toLocaleString()}枚</div>
          </div>
          <div class="log-right">
            <div class="sub">ビタ ${vRate}%</div>
            <div class="actions">
              <button class="btn-s" style="background:var(--s)" onclick="edit(${x.id})">編集</button>
              <button class="btn-s" style="background:var(--d)" onclick="remove(${x.id})">削除</button>
            </div>
          </div>
        </div>
      `;
    });

    document.getElementById("totalYen").innerText = Math.round(tYen).toLocaleString() + "円";
    document.getElementById("totalYen").className = "total-val " + (tYen >= 0 ? "plus" : "minus");
    document.getElementById("totalCoins").innerText = (tCoins >= 0 ? "+" : "") + Math.round(tCoins).toLocaleString() + "枚";
    document.getElementById("totalCoins").className = "total-val " + (tCoins >= 0 ? "plus" : "minus");
    document.getElementById("totalSpins").innerText = tSpins.toLocaleString() + "G";
    document.getElementById("totalVita").innerText = (tAtt > 0 ? (tSucc/tAtt*100).toFixed(1) : 0) + "%";
    
    if (tSaved > 0) {
      document.getElementById("bonusArea").style.display = "block";
      document.getElementById("totalSavedYen").innerText = Math.round(tSaved).toLocaleString();
    }
  }

  render();
</script>
</body>
</html>
